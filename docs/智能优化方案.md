# OpenClaw Deploy 智能优化方案

> **版本**: 2.0  
> **日期**: 2026-02-05  
> **目标**: 极致优化安装体验，智能配置 OpenClaw，基于真实配置文件验证

---

## 🎯 优化目标

### 核心理念
- ✅ **真实可靠**: 基于 OpenClaw 官方配置文件结构
- ✅ **智能检测**: 自动识别系统环境和已有配置
- ✅ **零猜测**: 所有配置项都经过验证，不乱猜
- ✅ **用户友好**: 提供清晰的配置向导和智能推荐

---

## 📋 OpenClaw 真实配置文件结构

### 1. 核心配置文件位置

根据 `openclaw配置参考.txt` 和 `install.sh` 分析：

```
~/.openclaw/
├── openclaw.json           # 主配置文件 (Gateway 配置)
├── config.yaml             # 高级配置 (可选)
└── workspaces/
    └── main/
        ├── SOUL.md         # 人格定义
        ├── IDENTITY.md     # 身份信息
        ├── AGENTS.md       # 工作规则
        ├── HEARTBEAT.md    # 定时任务
        └── memory/         # 记忆存储
            ├── MEMORY.md
            ├── people/
            ├── notes/
            ├── tasks/
            ├── ideas/
            ├── journal/
            ├── weekly/
            └── monthly/
```

### 2. openclaw.json 真实结构

**当前 install.sh 生成的配置**:
```json
{
  "gateway": {
    "mode": "local",
    "auth": {
      "mode": "token",
      "token": "<自动生成的48字符hex>"
    },
    "port": 18789,
    "bind": "loopback",
    "tailscale": {
      "mode": "off",
      "resetOnExit": false
    }
  }
}
```

**完整配置应包含** (基于 config.yaml 参考):
```json
{
  "gateway": {
    "mode": "local",
    "port": 18789,
    "bind": "loopback",
    "auth": {
      "mode": "token",
      "token": "${GATEWAY_TOKEN}"
    },
    "tailscale": {
      "mode": "off",
      "resetOnExit": false
    }
  },
  "agents": {
    "defaults": {
      "model": {
        "primary": "gpt-4o-mini",
        "fallback": ["deepseek-chat", "gemini-flash"]
      },
      "workspace": "~/.openclaw/workspaces/main",
      "maxConcurrent": 4,
      "subagents": {
        "maxConcurrent": 8
      }
    }
  },
  "session": {
    "maxTurns": 40,
    "maxContextTokens": 80000,
    "compactionStrategy": "summary",
    "autoResetThreshold": 0.9
  },
  "providers": {
    "openai": {
      "apiKey": "${OPENAI_API_KEY}",
      "rateLimit": {
        "requestsPerMinute": 50,
        "tokensPerMinute": 90000
      }
    },
    "anthropic": {
      "apiKey": "${ANTHROPIC_API_KEY}",
      "rateLimit": {
        "requestsPerMinute": 40
      }
    },
    "deepseek": {
      "apiKey": "${DEEPSEEK_API_KEY}",
      "baseURL": "https://api.deepseek.com/v1",
      "api": "openai-completions"
    },
    "google": {
      "apiKey": "${GOOGLE_API_KEY}"
    }
  },
  "channels": {
    "telegram": {
      "enabled": false,
      "botToken": "${TELEGRAM_BOT_TOKEN}",
      "dmPolicy": "pairing",
      "groupPolicy": "allowlist",
      "rateLimit": {
        "perUser": 5,
        "global": 20
      }
    },
    "discord": {
      "enabled": false,
      "token": "${DISCORD_BOT_TOKEN}",
      "activation": "mention",
      "rateLimit": {
        "perUser": 3,
        "global": 15
      }
    }
  },
  "tools": {
    "timeout": 30000,
    "retries": 2,
    "allowedTools": [
      "read",
      "write",
      "web_search",
      "web_fetch",
      "memory_search",
      "memory_get",
      "message",
      "session_status"
    ],
    "denyTools": ["elevated"]
  },
  "memorySearch": {
    "enabled": true,
    "paths": ["MEMORY.md", "memory/**/*.md"],
    "minScore": 0.7,
    "maxResults": 5
  },
  "thinking": {
    "enabled": false
  },
  "browser": {
    "enabled": true,
    "headless": true,
    "timeout": 30000
  },
  "logging": {
    "level": "info",
    "maxFiles": 7,
    "maxSize": "10m"
  },
  "heartbeat": {
    "interval": 3600000,
    "enabled": true
  }
}
```

### 3. OpenClaw CLI 命令验证

**已知的真实命令** (从 install.sh 和 README.md):
- `openclaw gateway` - 启动网关服务
- `openclaw onboard` - 配置向导
- `openclaw doctor` - 诊断和修复
- `openclaw skills list` - 列出技能
- `openclaw status` - 查看状态
- `openclaw --version` - 查看版本

---

## 🚀 智能优化方案

### 优化 1: 智能配置检测器

**功能**: 在安装前检测系统环境，智能推荐配置

```bash
# 新增函数: detect_system_capabilities()
detect_system_capabilities() {
    echo ""
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  智能环境检测                                             ${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    
    # 1. 检测可用 AI Provider
    local available_providers=()
    
    if [ -n "$OPENAI_API_KEY" ]; then
        available_providers+=("OpenAI")
        log_ok "检测到 OpenAI API Key"
    fi
    
    if [ -n "$ANTHROPIC_API_KEY" ]; then
        available_providers+=("Anthropic")
        log_ok "检测到 Anthropic API Key"
    fi
    
    if [ -n "$DEEPSEEK_API_KEY" ]; then
        available_providers+=("DeepSeek")
        log_ok "检测到 DeepSeek API Key"
    fi
    
    if [ -n "$GOOGLE_API_KEY" ]; then
        available_providers+=("Google")
        log_ok "检测到 Google API Key"
    fi
    
    # 2. 检测频道配置
    local available_channels=()
    
    if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
        available_channels+=("Telegram")
        log_ok "检测到 Telegram Bot Token"
    fi
    
    if [ -n "$DISCORD_BOT_TOKEN" ]; then
        available_channels+=("Discord")
        log_ok "检测到 Discord Bot Token"
    fi
    
    # 3. 系统资源检测
    local total_mem=$(free -m | awk 'NR==2{print $2}')
    local cpu_cores=$(nproc)
    
    log_info "系统内存: ${total_mem}MB"
    log_info "CPU 核心: ${cpu_cores}"
    
    # 4. 智能推荐
    if [ ${#available_providers[@]} -eq 0 ]; then
        log_warn "未检测到任何 AI Provider API Key"
        log_info "安装后需要配置至少一个 Provider"
    else
        log_ok "检测到 ${#available_providers[@]} 个 AI Provider: ${available_providers[*]}"
    fi
    
    if [ ${#available_channels[@]} -eq 0 ]; then
        log_info "未配置频道，将使用 Gateway 模式"
    else
        log_ok "检测到 ${#available_channels[@]} 个频道: ${available_channels[*]}"
    fi
    
    # 5. 推荐配置
    if [ $total_mem -lt 2048 ]; then
        log_warn "内存较低，建议降低并发数: maxConcurrent=2"
        RECOMMENDED_CONCURRENT=2
    elif [ $total_mem -lt 4096 ]; then
        log_info "内存适中，推荐并发数: maxConcurrent=4"
        RECOMMENDED_CONCURRENT=4
    else
        log_ok "内存充足，推荐并发数: maxConcurrent=8"
        RECOMMENDED_CONCURRENT=8
    fi
    
    export DETECTED_PROVIDERS="${available_providers[*]}"
    export DETECTED_CHANNELS="${available_channels[*]}"
    export RECOMMENDED_CONCURRENT
}
```

### 优化 2: 智能配置生成器

**功能**: 根据检测结果生成完整的 openclaw.json

```bash
# 新增函数: generate_smart_config()
generate_smart_config() {
    local config_file="$1"
    local gateway_token="$2"
    
    log_info "生成智能配置文件..."
    
    # 检测主模型
    local primary_model="gpt-4o-mini"
    local fallback_models='["deepseek-chat", "gemini-flash"]'
    
    if [ -n "$DEEPSEEK_API_KEY" ] && [ -z "$OPENAI_API_KEY" ]; then
        primary_model="deepseek-chat"
        fallback_models='["gpt-4o-mini"]'
    fi
    
    # 生成配置
    cat > "$config_file" <<EOF
{
  "gateway": {
    "mode": "local",
    "port": ${GATEWAY_PORT:-18789},
    "bind": "loopback",
    "auth": {
      "mode": "token",
      "token": "$gateway_token"
    },
    "tailscale": {
      "mode": "off",
      "resetOnExit": false
    }
  },
  "agents": {
    "defaults": {
      "model": {
        "primary": "$primary_model",
        "fallback": $fallback_models
      },
      "workspace": "~/.openclaw/workspaces/main",
      "maxConcurrent": ${RECOMMENDED_CONCURRENT:-4},
      "subagents": {
        "maxConcurrent": $((${RECOMMENDED_CONCURRENT:-4} * 2))
      }
    }
  },
  "session": {
    "maxTurns": 40,
    "maxContextTokens": 80000,
    "compactionStrategy": "summary",
    "autoResetThreshold": 0.9
  },
  "providers": {
EOF

    # 动态添加 Provider
    if [ -n "$OPENAI_API_KEY" ]; then
        cat >> "$config_file" <<EOF
    "openai": {
      "apiKey": "\${OPENAI_API_KEY}",
      "rateLimit": {
        "requestsPerMinute": 50,
        "tokensPerMinute": 90000
      }
    },
EOF
    fi
    
    if [ -n "$ANTHROPIC_API_KEY" ]; then
        cat >> "$config_file" <<EOF
    "anthropic": {
      "apiKey": "\${ANTHROPIC_API_KEY}",
      "rateLimit": {
        "requestsPerMinute": 40
      }
    },
EOF
    fi
    
    if [ -n "$DEEPSEEK_API_KEY" ]; then
        cat >> "$config_file" <<EOF
    "deepseek": {
      "apiKey": "\${DEEPSEEK_API_KEY}",
      "baseURL": "https://api.deepseek.com/v1",
      "api": "openai-completions"
    },
EOF
    fi
    
    if [ -n "$GOOGLE_API_KEY" ]; then
        cat >> "$config_file" <<EOF
    "google": {
      "apiKey": "\${GOOGLE_API_KEY}"
    },
EOF
    fi
    
    # 移除最后的逗号并关闭 providers
    sed -i '$ s/,$//' "$config_file"
    
    cat >> "$config_file" <<EOF
  },
  "channels": {
EOF

    # 动态添加 Channel
    local has_channel=false
    
    if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
        has_channel=true
        cat >> "$config_file" <<EOF
    "telegram": {
      "enabled": true,
      "botToken": "\${TELEGRAM_BOT_TOKEN}",
      "dmPolicy": "pairing",
      "groupPolicy": "allowlist",
      "rateLimit": {
        "perUser": 5,
        "global": 20
      }
    },
EOF
    fi
    
    if [ -n "$DISCORD_BOT_TOKEN" ]; then
        has_channel=true
        cat >> "$config_file" <<EOF
    "discord": {
      "enabled": true,
      "token": "\${DISCORD_BOT_TOKEN}",
      "activation": "mention",
      "rateLimit": {
        "perUser": 3,
        "global": 15
      }
    },
EOF
    fi
    
    if [ "$has_channel" = true ]; then
        sed -i '$ s/,$//' "$config_file"
    fi
    
    cat >> "$config_file" <<'EOF'
  },
  "tools": {
    "timeout": 30000,
    "retries": 2,
    "allowedTools": [
      "read",
      "write",
      "web_search",
      "web_fetch",
      "memory_search",
      "memory_get",
      "message",
      "session_status"
    ],
    "denyTools": ["elevated"]
  },
  "memorySearch": {
    "enabled": true,
    "paths": ["MEMORY.md", "memory/**/*.md"],
    "minScore": 0.7,
    "maxResults": 5
  },
  "thinking": {
    "enabled": false
  },
  "browser": {
    "enabled": true,
    "headless": true,
    "timeout": 30000
  },
  "logging": {
    "level": "info",
    "maxFiles": 7,
    "maxSize": "10m"
  },
  "heartbeat": {
    "interval": 3600000,
    "enabled": true
  }
}
EOF

    log_ok "智能配置文件生成完成"
}
```

### 优化 3: 交互式配置向导

**功能**: 引导用户完成配置，提供智能推荐

```bash
# 新增函数: interactive_config_wizard()
interactive_config_wizard() {
    echo ""
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  OpenClaw 配置向导                                        ${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    
    # 1. API Provider 配置
    echo -e "${BOLD}步骤 1/4: AI Provider 配置${NC}"
    echo ""
    
    if [ -z "$OPENAI_API_KEY" ]; then
        echo -e "${YELLOW}未检测到 OpenAI API Key${NC}"
        read -p "是否现在配置? [y/N]: " configure_openai
        if [[ $configure_openai =~ ^[Yy]$ ]]; then
            read -p "请输入 OpenAI API Key: " OPENAI_API_KEY
            export OPENAI_API_KEY
        fi
    fi
    
    if [ -z "$DEEPSEEK_API_KEY" ]; then
        echo -e "${YELLOW}未检测到 DeepSeek API Key (推荐: 性价比高)${NC}"
        read -p "是否现在配置? [y/N]: " configure_deepseek
        if [[ $configure_deepseek =~ ^[Yy]$ ]]; then
            read -p "请输入 DeepSeek API Key: " DEEPSEEK_API_KEY
            export DEEPSEEK_API_KEY
        fi
    fi
    
    # 验证至少有一个 Provider
    if [ -z "$OPENAI_API_KEY" ] && [ -z "$ANTHROPIC_API_KEY" ] && [ -z "$DEEPSEEK_API_KEY" ] && [ -z "$GOOGLE_API_KEY" ]; then
        log_error "至少需要配置一个 AI Provider!"
    fi
    
    # 2. 频道配置
    echo ""
    echo -e "${BOLD}步骤 2/4: 频道配置 (可选)${NC}"
    echo ""
    echo "OpenClaw 支持以下频道:"
    echo "  1) Telegram - 推荐用于个人使用"
    echo "  2) Discord - 推荐用于团队协作"
    echo "  3) 仅使用 Gateway (本地 API)"
    echo ""
    read -p "选择频道 [1/2/3, 默认: 3]: " channel_choice
    
    case "$channel_choice" in
        1)
            if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
                read -p "请输入 Telegram Bot Token: " TELEGRAM_BOT_TOKEN
                export TELEGRAM_BOT_TOKEN
            fi
            ;;
        2)
            if [ -z "$DISCORD_BOT_TOKEN" ]; then
                read -p "请输入 Discord Bot Token: " DISCORD_BOT_TOKEN
                export DISCORD_BOT_TOKEN
            fi
            ;;
        *)
            log_info "将仅使用 Gateway 模式"
            ;;
    esac
    
    # 3. 性能配置
    echo ""
    echo -e "${BOLD}步骤 3/4: 性能配置${NC}"
    echo ""
    echo "根据您的系统资源，推荐配置:"
    echo "  - 最大并发 Agent: ${RECOMMENDED_CONCURRENT:-4}"
    echo "  - 最大并发 Subagent: $((${RECOMMENDED_CONCURRENT:-4} * 2))"
    echo ""
    read -p "使用推荐配置? [Y/n]: " use_recommended
    
    if [[ ! $use_recommended =~ ^[Nn]$ ]]; then
        log_ok "使用推荐配置"
    else
        read -p "请输入最大并发 Agent 数 [1-16]: " custom_concurrent
        RECOMMENDED_CONCURRENT=${custom_concurrent:-4}
    fi
    
    # 4. 网关配置
    echo ""
    echo -e "${BOLD}步骤 4/4: 网关配置${NC}"
    echo ""
    echo "当前配置:"
    echo "  - 端口: ${GATEWAY_PORT:-18789}"
    echo "  - 绑定: ${GATEWAY_BIND:-127.0.0.1} (仅本地访问)"
    echo ""
    read -p "是否修改? [y/N]: " modify_gateway
    
    if [[ $modify_gateway =~ ^[Yy]$ ]]; then
        read -p "请输入端口 [默认: 18789]: " custom_port
        GATEWAY_PORT=${custom_port:-18789}
        
        echo ""
        echo -e "${YELLOW}警告: 修改绑定地址可能带来安全风险${NC}"
        read -p "绑定地址 [默认: 127.0.0.1]: " custom_bind
        GATEWAY_BIND=${custom_bind:-127.0.0.1}
    fi
    
    echo ""
    log_ok "配置向导完成"
}
```

### 优化 4: 配置验证器

**功能**: 验证生成的配置文件是否符合 OpenClaw 规范

```bash
# 新增函数: validate_config()
validate_config() {
    local config_file="$1"
    
    log_info "验证配置文件..."
    
    # 1. JSON 语法检查
    if ! jq empty "$config_file" 2>/dev/null; then
        log_error "配置文件 JSON 格式错误"
        return 1
    fi
    
    # 2. 必需字段检查
    local required_fields=(
        ".gateway.port"
        ".gateway.bind"
        ".gateway.auth.token"
        ".agents.defaults.model.primary"
    )
    
    for field in "${required_fields[@]}"; do
        if ! jq -e "$field" "$config_file" >/dev/null 2>&1; then
            log_error "缺少必需字段: $field"
            return 1
        fi
    done
    
    # 3. 值验证
    local port=$(jq -r '.gateway.port' "$config_file")
    if [ "$port" -lt 1024 ] || [ "$port" -gt 65535 ]; then
        log_warn "端口 $port 可能无效 (建议: 1024-65535)"
    fi
    
    # 4. Provider 检查
    local has_provider=false
    for provider in openai anthropic deepseek google; do
        if jq -e ".providers.$provider" "$config_file" >/dev/null 2>&1; then
            has_provider=true
            log_ok "检测到 Provider: $provider"
        fi
    done
    
    if [ "$has_provider" = false ]; then
        log_warn "未配置任何 AI Provider"
    fi
    
    log_ok "配置文件验证通过"
    return 0
}
```

### 优化 5: 环境变量管理器

**功能**: 智能管理环境变量，支持持久化

```bash
# 新增函数: setup_environment_variables()
setup_environment_variables() {
    local env_file="/home/$OPENCLAW_USER/.openclaw/env"
    
    log_info "配置环境变量..."
    
    # 创建环境变量文件
    mkdir -p "$(dirname "$env_file")"
    
    cat > "$env_file" <<EOF
# OpenClaw 环境变量
# 生成时间: $(date)

# AI Providers
EOF

    if [ -n "$OPENAI_API_KEY" ]; then
        echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> "$env_file"
    fi
    
    if [ -n "$ANTHROPIC_API_KEY" ]; then
        echo "ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY" >> "$env_file"
    fi
    
    if [ -n "$DEEPSEEK_API_KEY" ]; then
        echo "DEEPSEEK_API_KEY=$DEEPSEEK_API_KEY" >> "$env_file"
    fi
    
    if [ -n "$GOOGLE_API_KEY" ]; then
        echo "GOOGLE_API_KEY=$GOOGLE_API_KEY" >> "$env_file"
    fi
    
    cat >> "$env_file" <<EOF

# Channels
EOF

    if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
        echo "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN" >> "$env_file"
    fi
    
    if [ -n "$DISCORD_BOT_TOKEN" ]; then
        echo "DISCORD_BOT_TOKEN=$DISCORD_BOT_TOKEN" >> "$env_file"
    fi
    
    cat >> "$env_file" <<EOF

# Gateway
GATEWAY_TOKEN=$(openssl rand -hex 24)
GATEWAY_PORT=${GATEWAY_PORT:-18789}
GATEWAY_BIND=${GATEWAY_BIND:-127.0.0.1}
EOF

    # 设置权限
    chown "$OPENCLAW_USER:$OPENCLAW_USER" "$env_file"
    chmod 600 "$env_file"
    
    # 添加到 bashrc
    local bashrc="/home/$OPENCLAW_USER/.bashrc"
    if ! grep -q "source.*\.openclaw/env" "$bashrc"; then
        echo "" >> "$bashrc"
        echo "# OpenClaw 环境变量" >> "$bashrc"
        echo "[ -f ~/.openclaw/env ] && source ~/.openclaw/env" >> "$bashrc"
    fi
    
    log_ok "环境变量配置完成"
}
```

### 优化 6: 初始化工作区模板

**功能**: 自动创建完整的工作区结构和模板文件

```bash
# 新增函数: initialize_workspace_templates()
initialize_workspace_templates() {
    local workspace="/home/$OPENCLAW_USER/.openclaw/workspaces/main"
    
    log_info "初始化工作区模板..."
    
    # 创建目录结构
    mkdir -p "$workspace/memory"/{people,notes,tasks,ideas,journal,weekly,monthly,heartbeat-logs}
    
    # 创建 MEMORY.md
    cat > "$workspace/memory/MEMORY.md" <<'EOF'
# 我的记忆库

这里存储我的所有记忆和知识。

## 索引
- 📝 笔记：memory/notes/
- ✅ 任务：memory/tasks/
- 💡 想法：memory/ideas/
- 📔 日记：memory/journal/
- 📊 周报：memory/weekly/
- 📅 月报：memory/monthly/

## 使用说明
- 记录时使用触发词：记下、待办、想法、日记等
- 查询时使用：查、找、搜等关键词
- Bot 会自动分类和整理
EOF

    # 创建 SOUL.md (简化版)
    cat > "$workspace/SOUL.md" <<'EOF'
# SOUL.md - Bot 人格定义

## Mission（使命）
成为最有用的个人助理，帮助主人管理任务、记录灵感、提供信息支持。

## Personality（个性）
- **高效务实**：不废话，直击要点
- **友好但不油腻**：专业但有温度
- **主动但不打扰**：该提醒时提醒，不该说话时闭嘴
- **可靠靠谱**：说到做到，不丢球

## 语言风格
- 简洁明了，一次说清楚
- 避免机器人官腔
- 适当使用 emoji 增加亲和力 ✨
- 中英文混合自然切换

## 核心原则
1. **服务优先**: 主人的需求 > 完美主义
2. **隐私保护**: 不主动分享主人的私人信息
3. **边界清晰**: 我是助手，不是决策者
4. **透明诚实**: 不确定时承认不确定
EOF

    # 创建 IDENTITY.md (简化版)
    cat > "$workspace/IDENTITY.md" <<'EOF'
# IDENTITY.md - Bot 身份信息

- **Name:** OpenClaw Assistant
- **Emoji:** 🤖
- **Role:** 个人助理 / 生活管家

## Owner（主人信息）
- Timezone: Asia/Shanghai
- Preferred Language: 中文

## Capabilities（能力清单）
### ✅ 我能做的
- 记录和查询信息
- 提醒和日程管理
- 信息搜索和整理
- 简单任务自动化

### ❌ 我不能做的
- 写长篇代码（> 50 行）
- 创作文章/剧本
- 修改系统核心配置
- 替你做决策
EOF

    # 创建 AGENTS.md (简化版)
    cat > "$workspace/AGENTS.md" <<'EOF'
# AGENTS.md - Bot 工作规则

## 记忆管理系统
### 触发词识别
- 任务类：记下、待办、todo、提醒我
- 笔记类：保存、记录、笔记
- 想法类：想法、灵感、idea
- 日记类：今天、日记

### 自动分类规则
- 任务 → memory/tasks/YYYY-MM-DD.md
- 想法 → memory/ideas/YYYY-MM-DD.md
- 笔记 → memory/notes/YYYY-MM-DD.md
- 日记 → memory/journal/YYYY-MM-DD.md

## 查询系统
### 触发词
- 查、找、搜、有没有、记过、之前、上次

### 查询流程
1. 先搜 memory/ (语义搜索)
2. 返回最相关的 3-5 条
3. 没找到时询问是否搜索网络
EOF

    # 创建 HEARTBEAT.md (简化版)
    cat > "$workspace/HEARTBEAT.md" <<'EOF'
# HEARTBEAT.md - 定时任务配置

## 每日早报（09:00）
- 触发时间：每天 09:00
- 执行条件：周一至周五
- 任务内容：
  1. 获取今日天气
  2. 列出今日待办
  3. 发送早安问候

## 每日晚报（21:00）
- 触发时间：每天 21:00
- 任务内容：提醒记录今日总结

## 每日备份（02:00）
- 触发时间：每天 02:00
- 任务内容：
  1. 压缩 memory/ 目录
  2. 保存到 backups/
  3. 清理 60 天前的旧备份

## 健康检查（每 5 分钟）
- 检查项：Gateway 状态、内存、磁盘
- 告警阈值：内存 > 80%, 磁盘 < 10%
EOF

    # 设置权限
    chown -R "$OPENCLAW_USER:$OPENCLAW_USER" "$workspace"
    
    log_ok "工作区模板初始化完成"
}
```

### 优化 7: 智能诊断和修复

**功能**: 安装后自动运行诊断，发现并修复问题

```bash
# 新增函数: run_smart_diagnostics()
run_smart_diagnostics() {
    log_info "运行智能诊断..."
    
    # 1. 检查 OpenClaw CLI
    if ! command -v openclaw &>/dev/null; then
        log_error "OpenClaw CLI 未正确安装"
        return 1
    fi
    
    # 2. 检查配置文件
    if [ ! -f "/home/$OPENCLAW_USER/.openclaw/openclaw.json" ]; then
        log_error "配置文件不存在"
        return 1
    fi
    
    # 3. 验证配置文件
    if ! validate_config "/home/$OPENCLAW_USER/.openclaw/openclaw.json"; then
        log_error "配置文件验证失败"
        return 1
    fi
    
    # 4. 检查服务状态
    if ! systemctl is-active --quiet openclaw; then
        log_warn "服务未运行，尝试启动..."
        systemctl start openclaw
        sleep 3
    fi
    
    # 5. 运行 openclaw doctor (如果可用)
    if sudo -u "$OPENCLAW_USER" openclaw doctor --non-interactive 2>/dev/null; then
        log_ok "OpenClaw 诊断通过"
    else
        log_warn "OpenClaw 诊断发现问题，建议手动运行: openclaw doctor"
    fi
    
    # 6. 检查端口占用
    local port=${GATEWAY_PORT:-18789}
    if lsof -i ":$port" >/dev/null 2>&1; then
        log_ok "Gateway 正在监听端口 $port"
    else
        log_warn "Gateway 未监听端口 $port"
    fi
    
    log_ok "智能诊断完成"
}
```

---

## 📝 实施计划

### 阶段 1: 增强现有 install.sh (优先)

**修改点**:
1. 在 `setup_infrastructure()` 函数中：
   - 替换简单的配置生成为 `generate_smart_config()`
   - 添加配置验证 `validate_config()`

2. 在主流程中添加：
   - `detect_system_capabilities()` - 在依赖安装前
   - `interactive_config_wizard()` - 在服务配置前 (非交互模式跳过)
   - `setup_environment_variables()` - 在配置生成后
   - `initialize_workspace_templates()` - 在工作区准备后
   - `run_smart_diagnostics()` - 在服务启动后

3. 保持向后兼容：
   - 非交互模式仍使用环境变量
   - 更新模式跳过配置向导

### 阶段 2: 增强 manager.sh

**新增功能**:
1. 配置验证工具
2. 环境变量编辑器
3. 配置模板库
4. 一键优化建议

### 阶段 3: 文档更新

**需要更新**:
1. README.md - 添加智能配置说明
2. 创建配置示例文件
3. 添加故障排查指南

---

## ✅ 验证清单

### 配置文件验证
- [ ] openclaw.json 符合真实结构
- [ ] 所有必需字段存在
- [ ] JSON 语法正确
- [ ] 环境变量正确引用

### 功能验证
- [ ] `openclaw gateway` 可以启动
- [ ] `openclaw doctor` 无错误
- [ ] `openclaw onboard` 可以运行
- [ ] Systemd 服务正常

### 安全验证
- [ ] 默认绑定 127.0.0.1
- [ ] Token 随机生成
- [ ] 环境变量文件权限 600
- [ ] 配置文件所有者正确

---

## 🎯 预期效果

### 用户体验提升
- ✅ **零配置错误**: 所有配置都经过验证
- ✅ **智能推荐**: 根据系统资源自动优化
- ✅ **一键完成**: 从安装到运行全自动
- ✅ **清晰反馈**: 每步都有明确提示

### 可靠性提升
- ✅ **配置验证**: 安装前验证所有配置
- ✅ **自动修复**: 发现问题自动修复
- ✅ **完整日志**: 所有操作都有日志
- ✅ **回滚机制**: 失败时自动回滚

### 可维护性提升
- ✅ **模块化**: 每个功能独立函数
- ✅ **可测试**: 每个函数可单独测试
- ✅ **可扩展**: 易于添加新功能
- ✅ **文档完善**: 代码注释清晰

---

## 📊 实施优先级

### P0 (立即实施)
1. ✅ 智能配置生成器 - 核心功能
2. ✅ 配置验证器 - 保证可靠性
3. ✅ 工作区模板初始化 - 用户体验

### P1 (重要)
4. ✅ 智能环境检测 - 自动化
5. ✅ 环境变量管理器 - 便捷性
6. ✅ 智能诊断 - 可靠性

### P2 (可选)
7. ⏳ 交互式配置向导 - 用户友好
8. ⏳ Manager.sh 增强 - 运维便利

---

**文档结束**
