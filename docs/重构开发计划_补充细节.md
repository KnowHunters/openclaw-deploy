# OpenClaw Deploy 重构开发计划 - 补充细节

> **版本**: 2.0.1  
> **日期**: 2026-02-05  
> **重点**: 用户权限、小白友好、最佳实践

---

## 🎯 核心原则：面向纯小白用户

### 设计理念

```
用户画像：
- 第一次接触 Linux 服务器
- 不了解 root/sudo 的区别
- 不知道什么是环境变量
- 不清楚文件权限概念
- 可能直接用 root 登录服务器
- 可能不知道如何创建用户
```

**我们的目标**：让用户只需要复制粘贴一条命令，剩下的全部自动处理或交互式引导。

---

## 🔐 用户权限完整方案

### 1. 启动时用户检测流程

```
┌─────────────────────────────────────────────────────────────┐
│                      脚本启动                               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                 检测当前用户                                │
│                 $(whoami)                                   │
└─────────────────────┬───────────────────────────────────────┘
                      │
          ┌───────────┴───────────┐
          │                       │
          ▼                       ▼
    ┌──────────┐           ┌──────────┐
    │  root    │           │ 普通用户  │
    └────┬─────┘           └────┬─────┘
         │                      │
         ▼                      ▼
┌─────────────────┐    ┌─────────────────┐
│ 警告并引导创建  │    │ 检查 sudo 权限  │
│ 或切换到普通用户│    │                 │
└────────┬────────┘    └────────┬────────┘
         │                      │
         ▼                      │
┌─────────────────┐             │
│ 1. 创建新用户   │             │
│ 2. 切换到已有   │             │
│ 3. 强制继续(警告)│            │
└────────┬────────┘             │
         │                      │
         └──────────┬───────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                   继续安装流程                              │
└─────────────────────────────────────────────────────────────┘
```

### 2. Root 用户检测和处理

#### 2.1 检测代码

```bash
# 检测是否为 root 用户
check_root_user() {
    if [ "$(id -u)" -eq 0 ]; then
        return 0  # 是 root
    else
        return 1  # 不是 root
    fi
}

# 检测是否有 sudo 权限
check_sudo_permission() {
    if sudo -n true 2>/dev/null; then
        return 0  # 有 sudo 权限
    else
        return 1  # 没有 sudo 权限
    fi
}
```

#### 2.2 Root 用户警告界面

```
╔══════════════════════════════════════════════════════════════╗
║  ⚠️  检测到您正在使用 root 用户                              ║
╚══════════════════════════════════════════════════════════════╝

  ┌─────────────────────────────────────────────────────────┐
  │ 🚫 为什么不能用 root 用户运行 OpenClaw？                │
  ├─────────────────────────────────────────────────────────┤
  │                                                         │
  │  1. 安全风险                                            │
  │     root 用户拥有系统最高权限，如果 OpenClaw 或其       │
  │     插件存在漏洞，可能导致整个系统被攻击。              │
  │                                                         │
  │  2. 权限隔离                                            │
  │     使用专用用户可以限制 OpenClaw 的访问范围，          │
  │     即使出问题也不会影响系统其他部分。                  │
  │                                                         │
  │  3. 官方要求                                            │
  │     OpenClaw 官方不建议以 root 身份运行。               │
  │                                                         │
  └─────────────────────────────────────────────────────────┘

  请选择操作：

  ❯ 🆕 创建新用户 (推荐)
      自动创建 'openclaw' 用户并配置权限
    
    👤 切换到已有用户
      选择一个已存在的普通用户
    
    ⚠️  强制以 root 继续 (不推荐)
      了解风险后继续，但某些功能可能受限

  ↑/↓ 选择  Enter 确认
```

#### 2.3 创建新用户流程

```bash
# 创建 OpenClaw 专用用户
create_openclaw_user() {
    local username=${1:-openclaw}
    
    show_step "创建用户 '$username'"
    
    # 检查用户是否已存在
    if id "$username" &>/dev/null; then
        log_warning "用户 '$username' 已存在"
        if confirm_box "是否使用现有用户 '$username'?"; then
            OPENCLAW_USER="$username"
            return 0
        else
            # 让用户输入新用户名
            username=$(input_box "请输入新用户名" "openclaw2")
        fi
    fi
    
    # 创建用户
    log_info "正在创建用户 '$username'..."
    
    # 创建用户（带 home 目录）
    useradd -m -s /bin/bash "$username" || {
        log_error "创建用户失败"
        return 1
    }
    
    # 设置密码（交互式）
    echo ""
    echo -e "  ${BOLD}请为用户 '$username' 设置密码${RESET}"
    echo -e "  ${DIM}(输入时不会显示，这是正常的)${RESET}"
    echo ""
    passwd "$username" || {
        log_error "设置密码失败"
        return 1
    }
    
    # 添加到 sudo 组
    if confirm_box "是否给予 '$username' sudo 权限? (推荐)"; then
        usermod -aG sudo "$username" 2>/dev/null || \
        usermod -aG wheel "$username" 2>/dev/null || {
            log_warning "添加 sudo 权限失败，可能需要手动配置"
        }
        log_success "已添加 sudo 权限"
    fi
    
    OPENCLAW_USER="$username"
    log_success "用户 '$username' 创建成功"
    
    return 0
}
```

#### 2.4 切换用户并继续

```bash
# 切换到指定用户并继续执行脚本
switch_user_and_continue() {
    local target_user=$1
    local script_path=$(realpath "$0")
    local script_args="$*"
    
    echo ""
    log_info "即将切换到用户 '$target_user' 并继续安装..."
    echo ""
    
    # 方法 1: 使用 su 切换（推荐）
    if [ -n "$DISPLAY" ] || [ -n "$SSH_TTY" ]; then
        # 交互式终端
        echo -e "  ${INFO}请输入用户 '$target_user' 的密码：${RESET}"
        exec su - "$target_user" -c "bash $script_path $script_args"
    else
        # 非交互式
        exec sudo -u "$target_user" bash "$script_path" "$script_args"
    fi
}

# 提示用户手动切换
prompt_manual_switch() {
    local target_user=$1
    
    echo ""
    echo -e "  ┌─────────────────────────────────────────────────────────┐"
    echo -e "  │ 📋 请手动切换用户后重新运行脚本                        │"
    echo -e "  ├─────────────────────────────────────────────────────────┤"
    echo -e "  │                                                         │"
    echo -e "  │  方法 1: 使用 su 命令                                   │"
    echo -e "  │  ${CYAN}su - $target_user${RESET}                                       │"
    echo -e "  │  然后重新运行安装脚本                                   │"
    echo -e "  │                                                         │"
    echo -e "  │  方法 2: 使用 SSH 重新登录                              │"
    echo -e "  │  ${CYAN}ssh $target_user@服务器IP${RESET}                               │"
    echo -e "  │                                                         │"
    echo -e "  │  方法 3: 退出当前会话                                   │"
    echo -e "  │  ${CYAN}exit${RESET}                                                    │"
    echo -e "  │  然后用 '$target_user' 用户重新登录                     │"
    echo -e "  │                                                         │"
    echo -e "  └─────────────────────────────────────────────────────────┘"
    echo ""
    
    # 复制命令到剪贴板（如果可能）
    local install_cmd="curl -fsSL https://your-repo/deploy.sh | bash"
    echo -e "  安装命令（切换用户后执行）："
    echo -e "  ${CYAN}$install_cmd${RESET}"
    echo ""
}
```

### 3. 普通用户权限检查

```bash
# 检查普通用户的权限
check_user_permissions() {
    local issues=()
    
    show_step "检查用户权限"
    
    # 1. 检查 sudo 权限
    if ! check_sudo_permission; then
        issues+=("没有 sudo 权限，无法安装系统依赖")
    else
        log_success "sudo 权限正常"
    fi
    
    # 2. 检查 home 目录
    if [ ! -d "$HOME" ]; then
        issues+=("home 目录不存在: $HOME")
    elif [ ! -w "$HOME" ]; then
        issues+=("home 目录不可写: $HOME")
    else
        log_success "home 目录正常: $HOME"
    fi
    
    # 3. 检查 shell
    local user_shell=$(getent passwd $(whoami) | cut -d: -f7)
    if [[ "$user_shell" != *"bash"* ]] && [[ "$user_shell" != *"zsh"* ]]; then
        issues+=("当前 shell ($user_shell) 可能不兼容，建议使用 bash")
    else
        log_success "Shell 正常: $user_shell"
    fi
    
    # 4. 检查是否在 docker/systemd-nspawn 容器中
    if [ -f "/.dockerenv" ] || grep -q "docker\|lxc" /proc/1/cgroup 2>/dev/null; then
        log_warning "检测到容器环境，某些功能可能受限"
    fi
    
    # 报告问题
    if [ ${#issues[@]} -gt 0 ]; then
        echo ""
        log_error "发现以下权限问题："
        for issue in "${issues[@]}"; do
            echo -e "    ${ERROR}•${RESET} $issue"
        done
        echo ""
        
        if confirm_box "是否尝试自动修复?"; then
            fix_permission_issues "${issues[@]}"
        else
            return 1
        fi
    fi
    
    return 0
}
```

---

## 📁 配置文件位置和权限

### 1. 目录结构规划

```
/home/<用户名>/
├── .openclaw/                      # OpenClaw 主目录 (700)
│   ├── openclaw.json               # 主配置文件 (600)
│   ├── .env                        # 环境变量 (600) - 包含 API Key
│   ├── credentials/                # 认证目录 (700)
│   │   └── oauth.json              # OAuth 凭据 (600)
│   ├── agents/                     # Agent 目录 (755)
│   │   └── main/                   # 默认 Agent
│   │       └── agent/
│   │           └── auth-profiles.json
│   ├── workspace/                  # 工作区 (755)
│   │   ├── SOUL.md
│   │   ├── IDENTITY.md
│   │   ├── AGENTS.md
│   │   ├── HEARTBEAT.md
│   │   └── memory/                 # 记忆存储
│   ├── skills/                     # 技能目录 (755)
│   ├── logs/                       # 日志目录 (755)
│   └── backups/                    # 备份目录 (755)
│
├── .npm-global/                    # npm 全局安装目录 (755)
│   └── bin/                        # 可执行文件
│       └── openclaw -> ...
│
└── .bashrc                         # 添加 PATH 配置

/etc/systemd/system/
└── openclaw.service                # systemd 服务文件 (644, root:root)

/var/log/
└── openclaw/                       # 系统日志目录 (755, openclaw:openclaw)
    └── health.log
```

### 2. 权限设置代码

```bash
# 设置正确的目录权限
setup_directory_permissions() {
    local user=$1
    local home_dir=$(eval echo "~$user")
    local openclaw_dir="$home_dir/.openclaw"
    
    show_step "配置目录权限"
    
    # 创建目录结构
    local dirs=(
        "$openclaw_dir"
        "$openclaw_dir/credentials"
        "$openclaw_dir/agents"
        "$openclaw_dir/workspace"
        "$openclaw_dir/workspace/memory"
        "$openclaw_dir/skills"
        "$openclaw_dir/logs"
        "$openclaw_dir/backups"
    )
    
    for dir in "${dirs[@]}"; do
        mkdir -p "$dir"
        log_info "创建目录: $dir"
    done
    
    # 设置目录权限
    chmod 700 "$openclaw_dir"                    # 主目录：仅所有者
    chmod 700 "$openclaw_dir/credentials"        # 认证目录：仅所有者
    chmod 755 "$openclaw_dir/agents"             # Agent 目录
    chmod 755 "$openclaw_dir/workspace"          # 工作区
    chmod 755 "$openclaw_dir/skills"             # 技能目录
    chmod 755 "$openclaw_dir/logs"               # 日志目录
    chmod 755 "$openclaw_dir/backups"            # 备份目录
    
    # 设置敏感文件权限
    [ -f "$openclaw_dir/openclaw.json" ] && chmod 600 "$openclaw_dir/openclaw.json"
    [ -f "$openclaw_dir/.env" ] && chmod 600 "$openclaw_dir/.env"
    [ -f "$openclaw_dir/credentials/oauth.json" ] && chmod 600 "$openclaw_dir/credentials/oauth.json"
    
    # 设置所有者
    chown -R "$user:$user" "$openclaw_dir"
    
    log_success "目录权限配置完成"
}

# 验证权限设置
verify_permissions() {
    local user=$1
    local home_dir=$(eval echo "~$user")
    local openclaw_dir="$home_dir/.openclaw"
    local issues=()
    
    # 检查敏感文件权限
    if [ -f "$openclaw_dir/.env" ]; then
        local env_perm=$(stat -c "%a" "$openclaw_dir/.env" 2>/dev/null || stat -f "%OLp" "$openclaw_dir/.env")
        if [ "$env_perm" != "600" ]; then
            issues+=(".env 文件权限不安全 (当前: $env_perm, 应为: 600)")
        fi
    fi
    
    if [ -f "$openclaw_dir/openclaw.json" ]; then
        local config_perm=$(stat -c "%a" "$openclaw_dir/openclaw.json" 2>/dev/null || stat -f "%OLp" "$openclaw_dir/openclaw.json")
        if [ "$config_perm" != "600" ]; then
            issues+=("openclaw.json 文件权限不安全 (当前: $config_perm, 应为: 600)")
        fi
    fi
    
    # 检查所有者
    local dir_owner=$(stat -c "%U" "$openclaw_dir" 2>/dev/null || stat -f "%Su" "$openclaw_dir")
    if [ "$dir_owner" != "$user" ]; then
        issues+=(".openclaw 目录所有者错误 (当前: $dir_owner, 应为: $user)")
    fi
    
    if [ ${#issues[@]} -gt 0 ]; then
        log_warning "权限检查发现问题："
        for issue in "${issues[@]}"; do
            echo -e "    ${WARNING}•${RESET} $issue"
        done
        return 1
    fi
    
    log_success "权限验证通过"
    return 0
}
```

### 3. 环境变量配置

```bash
# 配置用户环境变量
setup_user_environment() {
    local user=$1
    local home_dir=$(eval echo "~$user")
    local bashrc="$home_dir/.bashrc"
    local npm_global="$home_dir/.npm-global"
    
    show_step "配置用户环境"
    
    # 创建 npm 全局目录
    mkdir -p "$npm_global/bin"
    
    # 配置 npm 前缀
    sudo -u "$user" npm config set prefix "$npm_global" 2>/dev/null || true
    
    # 添加到 PATH
    local path_config="
# OpenClaw 环境配置 (由安装脚本自动添加)
export PATH=\"\$HOME/.npm-global/bin:\$PATH\"

# 加载 OpenClaw 环境变量
[ -f \"\$HOME/.openclaw/.env\" ] && source \"\$HOME/.openclaw/.env\"
"
    
    # 检查是否已添加
    if ! grep -q "OpenClaw 环境配置" "$bashrc" 2>/dev/null; then
        echo "$path_config" >> "$bashrc"
        log_success "已添加环境配置到 .bashrc"
    else
        log_info "环境配置已存在，跳过"
    fi
    
    # 设置所有者
    chown "$user:$user" "$bashrc"
    chown -R "$user:$user" "$npm_global"
    
    log_success "用户环境配置完成"
}
```

---

## 👶 小白用户友好设计

### 1. 术语解释系统

```bash
# 术语解释字典
declare -A TERM_EXPLANATIONS=(
    ["API Key"]="API Key 是访问 AI 服务的密钥，类似于密码。\n你需要在 AI 服务商的网站上注册并获取。"
    ["Gateway"]="Gateway 是 OpenClaw 的核心服务，负责接收和处理消息。\n它就像一个翻译官，把你的消息翻译给 AI。"
    ["Token"]="Token 是一种安全凭证，用于验证身份。\n类似于门禁卡，只有持有正确 Token 才能访问服务。"
    ["端口"]="端口是网络通信的入口，就像房间的门牌号。\n不同的服务使用不同的端口，避免冲突。"
    ["sudo"]="sudo 是一个命令，让普通用户临时获得管理员权限。\n使用时需要输入你的密码。"
    ["systemd"]="systemd 是 Linux 的服务管理器。\n它负责启动、停止和监控各种服务。"
    ["SSH"]="SSH 是一种安全的远程登录方式。\n你可以通过 SSH 从自己的电脑连接到服务器。"
    ["环境变量"]="环境变量是系统中的全局设置。\n程序可以读取这些设置来获取配置信息。"
)

# 显示术语解释
explain_term() {
    local term=$1
    local explanation=${TERM_EXPLANATIONS[$term]}
    
    if [ -n "$explanation" ]; then
        echo ""
        echo -e "  ┌─────────────────────────────────────────────────────────┐"
        echo -e "  │ 💡 什么是 ${BOLD}$term${RESET}？"
        echo -e "  ├─────────────────────────────────────────────────────────┤"
        echo -e "$explanation" | while read line; do
            echo -e "  │   $line"
        done
        echo -e "  └─────────────────────────────────────────────────────────┘"
        echo ""
    fi
}

# 带解释的输入框
input_with_explanation() {
    local prompt=$1
    local default=$2
    local term=$3
    local secret=${4:-false}
    
    # 显示解释（如果用户需要）
    echo -ne "  ${BOLD}$prompt${RESET}"
    [ -n "$default" ] && echo -ne " ${DIM}[$default]${RESET}"
    echo -ne " ${DIM}(输入 ? 查看帮助)${RESET}: "
    
    while true; do
        if [ "$secret" = true ]; then
            read -rs result
            echo
        else
            read result
        fi
        
        if [ "$result" = "?" ]; then
            explain_term "$term"
            echo -ne "  ${BOLD}$prompt${RESET}"
            [ -n "$default" ] && echo -ne " ${DIM}[$default]${RESET}"
            echo -ne ": "
        else
            break
        fi
    done
    
    echo "${result:-$default}"
}
```

### 2. 错误恢复指南

```bash
# 错误处理和恢复指南
handle_error_with_guide() {
    local error_code=$1
    local error_context=$2
    
    echo ""
    echo -e "  ╔═══════════════════════════════════════════════════════════╗"
    echo -e "  ║  ❌ 出错了，但别担心！                                    ║"
    echo -e "  ╚═══════════════════════════════════════════════════════════╝"
    echo ""
    
    case "$error_code" in
        "NETWORK_ERROR")
            echo -e "  ${BOLD}问题：${RESET}网络连接失败"
            echo ""
            echo -e "  ${BOLD}可能的原因：${RESET}"
            echo -e "    • 服务器没有联网"
            echo -e "    • 防火墙阻止了连接"
            echo -e "    • DNS 解析失败"
            echo ""
            echo -e "  ${BOLD}解决方法：${RESET}"
            echo -e "    1. 检查网络连接："
            echo -e "       ${CYAN}ping baidu.com${RESET}"
            echo ""
            echo -e "    2. 如果使用代理，设置代理："
            echo -e "       ${CYAN}export https_proxy=http://代理地址:端口${RESET}"
            echo ""
            echo -e "    3. 检查 DNS："
            echo -e "       ${CYAN}cat /etc/resolv.conf${RESET}"
            ;;
            
        "PERMISSION_DENIED")
            echo -e "  ${BOLD}问题：${RESET}权限不足"
            echo ""
            echo -e "  ${BOLD}可能的原因：${RESET}"
            echo -e "    • 当前用户没有足够的权限"
            echo -e "    • 文件或目录的所有者不正确"
            echo ""
            echo -e "  ${BOLD}解决方法：${RESET}"
            echo -e "    1. 使用 sudo 运行命令："
            echo -e "       ${CYAN}sudo <命令>${RESET}"
            echo ""
            echo -e "    2. 检查文件所有者："
            echo -e "       ${CYAN}ls -la ~/.openclaw${RESET}"
            echo ""
            echo -e "    3. 修复权限："
            echo -e "       ${CYAN}sudo chown -R \$(whoami) ~/.openclaw${RESET}"
            ;;
            
        "NODE_NOT_FOUND")
            echo -e "  ${BOLD}问题：${RESET}Node.js 未安装或版本过低"
            echo ""
            echo -e "  ${BOLD}解决方法：${RESET}"
            echo -e "    选择 '软件安装' 菜单，安装 Node.js v22"
            echo ""
            echo -e "    或手动安装："
            echo -e "    ${CYAN}curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -${RESET}"
            echo -e "    ${CYAN}sudo apt-get install -y nodejs${RESET}"
            ;;
            
        "CONFIG_INVALID")
            echo -e "  ${BOLD}问题：${RESET}配置文件格式错误"
            echo ""
            echo -e "  ${BOLD}解决方法：${RESET}"
            echo -e "    1. 运行诊断工具："
            echo -e "       ${CYAN}openclaw doctor${RESET}"
            echo ""
            echo -e "    2. 自动修复："
            echo -e "       ${CYAN}openclaw doctor --fix${RESET}"
            echo ""
            echo -e "    3. 重新配置："
            echo -e "       选择主菜单的 '系统配置向导'"
            ;;
            
        "SERVICE_FAILED")
            echo -e "  ${BOLD}问题：${RESET}服务启动失败"
            echo ""
            echo -e "  ${BOLD}解决方法：${RESET}"
            echo -e "    1. 查看服务状态："
            echo -e "       ${CYAN}systemctl status openclaw${RESET}"
            echo ""
            echo -e "    2. 查看详细日志："
            echo -e "       ${CYAN}journalctl -u openclaw -n 50${RESET}"
            echo ""
            echo -e "    3. 尝试手动启动："
            echo -e "       ${CYAN}openclaw gateway --verbose${RESET}"
            ;;
            
        *)
            echo -e "  ${BOLD}未知错误：${RESET}$error_context"
            echo ""
            echo -e "  ${BOLD}通用解决方法：${RESET}"
            echo -e "    1. 查看日志："
            echo -e "       ${CYAN}cat /tmp/openclaw_deploy.log${RESET}"
            echo ""
            echo -e "    2. 重新运行安装脚本"
            echo ""
            echo -e "    3. 寻求帮助："
            echo -e "       • GitHub Issues"
            echo -e "       • 社区讨论组"
            ;;
    esac
    
    echo ""
    echo -e "  ─────────────────────────────────────────────────────────────"
    echo ""
    
    if confirm_box "是否查看详细日志?"; then
        less /tmp/openclaw_deploy.log 2>/dev/null || cat /tmp/openclaw_deploy.log
    fi
}
```

### 3. 操作确认和回退

```bash
# 危险操作确认
confirm_dangerous_action() {
    local action=$1
    local description=$2
    
    echo ""
    echo -e "  ╔═══════════════════════════════════════════════════════════╗"
    echo -e "  ║  ⚠️  警告：即将执行敏感操作                               ║"
    echo -e "  ╚═══════════════════════════════════════════════════════════╝"
    echo ""
    echo -e "  ${BOLD}操作：${RESET}$action"
    echo -e "  ${BOLD}说明：${RESET}$description"
    echo ""
    echo -e "  ${WARNING}此操作可能会：${RESET}"
    echo -e "    • 覆盖现有配置"
    echo -e "    • 删除某些数据"
    echo -e "    • 需要重新配置"
    echo ""
    
    # 要求输入确认文字
    echo -e "  请输入 ${BOLD}确认${RESET} 继续，或按 Enter 取消："
    read -r confirm_text
    
    if [ "$confirm_text" = "确认" ] || [ "$confirm_text" = "confirm" ]; then
        return 0
    else
        log_info "操作已取消"
        return 1
    fi
}

# 自动备份
auto_backup_before_action() {
    local action=$1
    local backup_dir="$HOME/.openclaw/backups"
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_file="$backup_dir/auto_backup_${action}_${timestamp}.tar.gz"
    
    mkdir -p "$backup_dir"
    
    log_info "正在创建自动备份..."
    
    if tar -czf "$backup_file" -C "$HOME" .openclaw 2>/dev/null; then
        log_success "备份已创建: $backup_file"
        echo "$backup_file"
        return 0
    else
        log_warning "备份创建失败，但将继续操作"
        return 1
    fi
}

# 回退到备份
rollback_to_backup() {
    local backup_file=$1
    
    if [ ! -f "$backup_file" ]; then
        log_error "备份文件不存在: $backup_file"
        return 1
    fi
    
    log_info "正在恢复备份..."
    
    # 删除当前配置
    rm -rf "$HOME/.openclaw"
    
    # 恢复备份
    tar -xzf "$backup_file" -C "$HOME"
    
    log_success "已恢复到备份: $backup_file"
}
```

### 4. 进度保存和恢复

```bash
# 保存安装进度
save_install_progress() {
    local step=$1
    local progress_file="/tmp/openclaw_install_progress"
    
    cat > "$progress_file" <<EOF
INSTALL_STEP=$step
INSTALL_USER=$OPENCLAW_USER
INSTALL_VERSION=$INSTALL_VERSION
INSTALL_TIME=$(date +%s)
EOF
    
    log_info "进度已保存 (步骤: $step)"
}

# 检查并恢复进度
check_and_resume_progress() {
    local progress_file="/tmp/openclaw_install_progress"
    
    if [ -f "$progress_file" ]; then
        source "$progress_file"
        
        local elapsed=$(($(date +%s) - INSTALL_TIME))
        
        # 如果进度文件不超过 1 小时
        if [ $elapsed -lt 3600 ]; then
            echo ""
            echo -e "  ┌─────────────────────────────────────────────────────────┐"
            echo -e "  │ 📋 检测到未完成的安装                                   │"
            echo -e "  ├─────────────────────────────────────────────────────────┤"
            echo -e "  │   上次步骤: $INSTALL_STEP"
            echo -e "  │   安装用户: $INSTALL_USER"
            echo -e "  │   安装版本: $INSTALL_VERSION"
            echo -e "  │   中断时间: $(date -d @$INSTALL_TIME '+%Y-%m-%d %H:%M:%S')"
            echo -e "  └─────────────────────────────────────────────────────────┘"
            echo ""
            
            if confirm_box "是否从上次中断处继续?"; then
                return 0  # 继续
            fi
        fi
        
        rm -f "$progress_file"
    fi
    
    return 1  # 重新开始
}
```

### 5. 新手引导模式

```bash
# 新手引导开关
BEGINNER_MODE=true

# 显示新手提示
show_beginner_tip() {
    local tip=$1
    
    if [ "$BEGINNER_MODE" = true ]; then
        echo ""
        echo -e "  ${INFO}💡 提示：${RESET}$tip"
        echo ""
    fi
}

# 新手模式欢迎界面
show_beginner_welcome() {
    echo ""
    echo -e "  ╔═══════════════════════════════════════════════════════════╗"
    echo -e "  ║                                                           ║"
    echo -e "  ║   👋 欢迎使用 OpenClaw 智能部署系统！                     ║"
    echo -e "  ║                                                           ║"
    echo -e "  ║   这是一个交互式安装向导，会一步步引导您完成安装。        ║"
    echo -e "  ║                                                           ║"
    echo -e "  ║   📖 使用提示：                                           ║"
    echo -e "  ║   • 使用 ↑↓ 键选择选项                                    ║"
    echo -e "  ║   • 按 Enter 确认选择                                     ║"
    echo -e "  ║   • 输入 ? 可以查看帮助说明                               ║"
    echo -e "  ║   • 按 Ctrl+C 可以随时退出                                ║"
    echo -e "  ║                                                           ║"
    echo -e "  ║   如果遇到问题，系统会提供详细的解决方案。                ║"
    echo -e "  ║                                                           ║"
    echo -e "  ╚═══════════════════════════════════════════════════════════╝"
    echo ""
    
    if confirm_box "是否开启新手引导模式? (会显示更多说明)"; then
        BEGINNER_MODE=true
    else
        BEGINNER_MODE=false
    fi
}

# 步骤说明
show_step_explanation() {
    local step_num=$1
    local step_name=$2
    local explanation=$3
    
    echo ""
    echo -e "  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo -e "  ${BOLD}步骤 $step_num: $step_name${RESET}"
    echo -e "  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    
    if [ "$BEGINNER_MODE" = true ]; then
        echo ""
        echo -e "  ${DIM}$explanation${RESET}"
    fi
    
    echo ""
}
```

---

## 🔄 完整的启动流程

```bash
#!/bin/bash
# deploy.sh - OpenClaw 智能部署系统 v2.0

# 主入口
main() {
    # 0. 初始化
    init_script
    
    # 1. 显示 Banner
    show_banner
    
    # 2. 检查是否有未完成的安装
    if check_and_resume_progress; then
        resume_installation
        return
    fi
    
    # 3. 检测当前用户
    if check_root_user; then
        handle_root_user
        # 如果用户选择切换，脚本会重新以新用户身份运行
        # 如果用户选择强制继续，则继续执行
    fi
    
    # 4. 检查用户权限
    if ! check_user_permissions; then
        handle_permission_issues
    fi
    
    # 5. 新手欢迎（首次运行）
    if is_first_run; then
        show_beginner_welcome
    fi
    
    # 6. 环境检测
    detect_environment
    
    # 7. 显示检测结果和建议
    show_detection_result
    
    # 8. 进入主菜单或安装向导
    if [ "$OPENCLAW_INSTALLED" = true ]; then
        show_main_menu
    else
        if confirm_box "检测到 OpenClaw 未安装，是否开始安装向导?"; then
            run_install_wizard
        else
            show_main_menu
        fi
    fi
}

# 处理 root 用户
handle_root_user() {
    show_root_warning
    
    local choice=$(select_menu "请选择操作" \
        "🆕 创建新用户 (推荐)" \
        "👤 切换到已有用户" \
        "⚠️  强制以 root 继续 (不推荐)")
    
    case $choice in
        0)  # 创建新用户
            local username=$(input_box "请输入新用户名" "openclaw")
            create_openclaw_user "$username"
            switch_user_and_continue "$username" "$@"
            ;;
        1)  # 切换到已有用户
            local users=$(list_normal_users)
            local selected_user=$(select_menu "选择用户" $users)
            switch_user_and_continue "$selected_user" "$@"
            ;;
        2)  # 强制继续
            if confirm_dangerous_action "以 root 用户运行" "这可能带来安全风险"; then
                log_warning "以 root 用户继续，某些功能可能受限"
                OPENCLAW_USER="root"
            else
                exit 1
            fi
            ;;
    esac
}

# 运行脚本
main "$@"
```

---

## 📋 更新后的开发检查清单

### 用户权限模块
- [ ] root 用户检测
- [ ] root 用户警告界面
- [ ] 创建新用户功能
- [ ] 切换用户功能
- [ ] 手动切换提示
- [ ] sudo 权限检查
- [ ] home 目录检查
- [ ] shell 检查
- [ ] 容器环境检测

### 目录权限模块
- [ ] 目录结构创建
- [ ] 权限设置 (700/755/600)
- [ ] 所有者设置
- [ ] 权限验证
- [ ] 环境变量配置
- [ ] PATH 配置

### 小白友好模块
- [ ] 术语解释系统
- [ ] 带解释的输入框
- [ ] 错误恢复指南
- [ ] 危险操作确认
- [ ] 自动备份
- [ ] 回退功能
- [ ] 进度保存
- [ ] 进度恢复
- [ ] 新手引导模式
- [ ] 步骤说明

### 错误处理
- [ ] 网络错误处理
- [ ] 权限错误处理
- [ ] Node.js 错误处理
- [ ] 配置错误处理
- [ ] 服务错误处理
- [ ] 通用错误处理

---

## 🎯 关键设计原则总结

### 1. 用户权限
- ✅ **禁止 root**: 默认禁止 root 运行，提供清晰的原因说明
- ✅ **自动创建用户**: 一键创建专用用户
- ✅ **权限最小化**: 只授予必要的权限
- ✅ **敏感文件保护**: API Key 等文件权限 600

### 2. 小白友好
- ✅ **术语解释**: 随时可查看术语说明
- ✅ **错误指南**: 每种错误都有详细的解决方案
- ✅ **操作确认**: 危险操作需要二次确认
- ✅ **自动备份**: 修改前自动备份
- ✅ **进度恢复**: 中断后可继续

### 3. 安全最佳实践
- ✅ **用户隔离**: 使用专用用户运行
- ✅ **权限隔离**: 目录和文件权限严格控制
- ✅ **敏感信息保护**: API Key 不明文显示
- ✅ **自动备份**: 操作前自动备份

---

**文档结束** - 补充细节完成！🚀
