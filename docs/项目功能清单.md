# OpenClaw Deploy 项目功能清单

> **文档版本**: 2.0  
> **生成时间**: 2026-02-05  
> **项目**: OpenClaw 一键部署系统  
> **作者**: KnowHunters (知识猎人)

---

## 📋 项目概述

OpenClaw Deploy 是一个专为 Ubuntu 24.04 设计的全自动部署脚本，用于快速安装和配置 OpenClaw AI 助手系统。该项目提供完整的安装、配置、监控和运维解决方案。

---

## 🎯 核心功能模块

### 1. 智能安装系统 (`install.sh`)

#### 1.1 系统预检与优化
- ✅ **网络连通性检测**: 自动检测 GitHub 和 NPM 仓库连接
- ✅ **操作系统识别**: 检测并验证 Ubuntu 系统版本
- ✅ **内存检查**: 检测系统内存，低于 4GB 时自动创建 Swap
- ✅ **时区配置**: 自动设置为 Asia/Shanghai
- ✅ **Root 权限验证**: 确保以管理员权限运行

#### 1.2 依赖管理
**系统基础组件**:
- curl, wget, git, build-essential
- ca-certificates, gnupg, lsb-release, jq, unzip

**开发工具**:
- ripgrep (快速代码搜索)
- fd-find (文件查找)
- bat (语法高亮查看器)
- htop (系统监控)
- tree (目录树显示)

**媒体处理工具**:
- ffmpeg (视频处理)
- imagemagick (图像处理)
- graphicsmagick (图形处理)
- tesseract-ocr (OCR 识别)
- poppler-utils (PDF 工具)

**Python 环境**:
- Python 3 完整环境
- yt-dlp (视频下载)
- pandas, numpy (数据处理)
- beautifulsoup4 (网页解析)

**Node.js 环境**:
- Node.js v22+ (从官方源安装)
- NPM 包管理器
- 用户级 NPM 前缀配置

**浏览器**:
- Chromium (通过 snap 安装)

**开发工具**:
- GitHub CLI (gh)
- Linuxbrew (Homebrew for Linux)

**OpenClaw CLI**:
- 全局安装 openclaw 命令行工具
- 自动配置 PATH 环境变量
- 创建系统级软链接

#### 1.3 用户与权限管理
- ✅ **专用用户创建**: 创建 `openclaw` 用户运行服务
- ✅ **权限隔离**: 非 root 运行，提高安全性
- ✅ **NPM 权限修复**: 自动配置用户级 NPM 目录
- ✅ **Node 二进制权限**: 修复 PM2 spawn EACCES 问题
- ✅ **文件所有权**: 自动设置正确的文件所有者

#### 1.4 工作区初始化
**目录结构**:
```
/home/openclaw/
├── .openclaw/              # 配置目录
│   └── openclaw.json       # 主配置文件
├── openclaw-bot/           # 工作目录
├── openclaw-scripts/       # 运维脚本
└── openclaw-backups/       # 备份目录
```

#### 1.5 服务配置
**Systemd 服务**:
- 服务名称: `openclaw.service`
- 启动命令: `openclaw gateway`
- 自动重启: 故障后 10 秒重启
- 开机自启: 已启用
- 环境变量: 自动配置 PATH 和 NODE_ENV

**默认配置生成**:
- Gateway 端口: 18789
- 绑定地址: loopback (127.0.0.1)
- 认证模式: token
- 自动生成安全 Token (48 字符 hex)

#### 1.6 安装模式

**标准安装模式**:
- 完整系统检查和优化
- 安装所有依赖
- 配置服务和监控
- 自动启动配置向导

**更新模式** (`-u` 参数):
- 仅更新 OpenClaw CLI
- 保留所有配置文件
- 重启服务
- 跳过依赖安装

**非交互模式** (`-n` 参数):
- 适用于 CI/CD 环境
- 通过环境变量配置
- 无需用户输入
- 自动完成所有步骤

**快速模式** (`-f` 参数):
- 跳过非关键确认
- 加速安装流程

#### 1.7 安全特性
- ✅ **本地绑定**: 默认仅允许本地访问 (127.0.0.1)
- ✅ **配置备份**: 重装前自动备份现有配置
- ✅ **重装确认**: 需要输入 "DELETE" 确认危险操作
- ✅ **Git 配置保护**: 临时禁用可能冲突的 Git 配置
- ✅ **Token 生成**: 使用 openssl 生成安全随机 Token

#### 1.8 错误处理
- ✅ **Spinner 进度条**: 实时显示安装进度
- ✅ **详细日志**: 所有输出保存到 `/tmp/openclaw_install.log`
- ✅ **错误捕获**: 失败时显示最后 15 行日志
- ✅ **步骤计时**: 显示每个步骤的执行时间
- ✅ **优雅退出**: 错误时清理临时文件

---

### 2. 管理面板系统 (`scripts/manager.sh`)

#### 2.1 主要功能
**服务管理**:
- 启动/停止/重启 OpenClaw 服务
- 查看服务状态
- 查看实时日志
- 服务健康检查

**配置管理**:
- 编辑主配置文件 (openclaw.json)
- 配置人格定义 (SOUL.md)
- 配置身份信息 (IDENTITY.md)
- 配置工作规则 (AGENTS.md)
- 配置定时任务 (HEARTBEAT.md)

**备份与恢复**:
- 创建配置备份
- 列出所有备份
- 交互式恢复向导
- 自动清理旧备份 (30 天)

**系统维护**:
- 清理日志文件
- 查看性能统计
- 更新 OpenClaw CLI
- 运行诊断工具

**一键安装** (未安装时):
- 自动下载并执行 install.sh
- 引导用户完成安装

#### 2.2 用户界面
- ✅ **彩色菜单**: 美观的 ASCII 艺术标题
- ✅ **交互式选择**: 数字菜单选择
- ✅ **实时反馈**: 操作结果即时显示
- ✅ **错误提示**: 友好的错误信息
- ✅ **自动编辑器**: 自动安装 nano 编辑器

---

### 3. 健康监控系统 (`scripts/health-monitor.sh`)

#### 3.1 监控指标
**进程状态监控**:
- PM2 进程状态检查 (online/stopped/errored)
- 进程 PID 获取
- 自动恢复机制

**资源使用监控**:
- CPU 使用率监控 (阈值: 80%)
- 内存使用率监控 (阈值: 80%)
- 磁盘空间监控 (告警: 80%, 严重: 90%)

**稳定性监控**:
- PM2 重启次数检查 (阈值: 5 次)
- 崩溃循环检测

#### 3.2 自动恢复
- ✅ **智能重启**: 检测到故障自动重启服务
- ✅ **多重尝试**: 尝试多种启动方式
- ✅ **恢复验证**: 重启后验证服务状态
- ✅ **告警通知**: 支持邮件告警 (可选)

#### 3.3 日志记录
- 所有检查记录到 `/var/log/openclaw-health.log`
- 时间戳标记
- 彩色输出便于阅读

---

### 4. 备份系统 (`scripts/backup.sh`)

#### 4.1 备份功能
**自动备份**:
- 压缩工作目录为 tar.gz
- 排除 node_modules, *.log, .cache
- 文件名包含时间戳
- 自动设置正确的文件权限

**智能清理**:
- 默认保留 30 天备份
- 可自定义保留天数
- 自动删除过期备份

**备份验证**:
- 显示备份文件大小
- 列出最近 5 个备份
- 备份成功/失败提示

#### 4.2 定时任务
- 通过 Cron 每日凌晨 3 点自动备份
- 日志输出到专用文件

---

### 5. 日志清理系统 (`scripts/log-cleanup.sh`)

#### 5.1 清理范围
**PM2 日志**:
- 使用 `pm2 flush` 清空日志

**系统日志**:
- 清理 `/var/log/openclaw-*.log`
- 默认保留 7 天

**Systemd 日志**:
- 使用 `journalctl --vacuum-time` 清理
- 可自定义保留天数

#### 5.2 磁盘监控
- 显示当前磁盘使用情况
- 清理前后对比

---

### 6. 恢复系统 (`scripts/restore.sh`)

#### 6.1 恢复功能
**交互式恢复**:
- 列出所有可用备份
- 显示备份时间和大小
- 数字选择恢复目标

**安全确认**:
- 恢复前二次确认
- 显示将被覆盖的文件

**恢复验证**:
- 解压验证
- 文件权限修复
- 恢复成功提示

---

## 🔧 配置系统

### 7. OpenClaw 配置文件

#### 7.1 核心配置 (`~/.openclaw/openclaw.json`)
**Gateway 配置**:
- 端口: 18789 (可自定义)
- 绑定: loopback (127.0.0.1)
- 认证: token 模式
- Tailscale: 支持但默认关闭

#### 7.2 高级配置 (`~/.openclaw/config.yaml`)
**Agent 配置**:
- 主力模型: gpt-4o-mini
- 备用模型: deepseek-chat, gemini-flash
- 最大并发: 4 个 agent, 8 个 subagent
- 工作区: ~/.openclaw/workspaces/main

**Session 优化**:
- 最大轮次: 40
- 最大 Token: 80000
- 压缩策略: summary
- 自动重置阈值: 90%

**Provider 配置**:
- OpenAI (速率限制: 50 req/min, 90k tokens/min)
- Anthropic (速率限制: 40 req/min)
- DeepSeek (自定义 baseURL)
- Google (Gemini)

**频道配置**:
- Telegram (DM 配对, 群组白名单)
- Discord (提及激活)
- 速率限制保护

**工具配置**:
- 超时: 30 秒
- 重试: 2 次
- 白名单工具控制
- 禁用危险工具

**Memory 配置**:
- 语义搜索
- 最小相似度: 0.7
- 最大结果: 5 条

#### 7.3 人格配置文件

**SOUL.md** - 人格定义:
- 使命和个性
- 语言风格
- 核心原则
- 回复模板
- 禁止行为

**IDENTITY.md** - 身份信息:
- Bot 名称和角色
- 主人信息
- 能力清单
- 边界定义

**AGENTS.md** - 工作规则:
- 记忆管理系统
- 查询系统
- 提醒系统
- 自动化任务
- 安全权限

**HEARTBEAT.md** - 定时任务:
- 每日早报 (09:00)
- 每日晚报 (21:00)
- 每日备份 (02:00)
- 每周总结 (周日 20:00)
- 健康检查 (每 5 分钟)

---

## 🚀 快捷命令

### 8. 全局命令

**管理命令**:
- `claw` - 启动管理面板
- `openclaw` - OpenClaw CLI 工具

**服务命令**:
- `systemctl status openclaw` - 查看服务状态
- `systemctl restart openclaw` - 重启服务
- `systemctl logs openclaw` - 查看服务日志

**用户切换**:
- `su - openclaw` - 切换到 openclaw 用户

**OpenClaw CLI**:
- `openclaw gateway` - 启动网关
- `openclaw doctor` - 诊断和修复
- `openclaw onboard` - 配置向导
- `openclaw skills list` - 列出可用技能
- `openclaw status` - 查看状态

---

## 📊 自动化任务

### 9. Cron 任务

**健康检查** (每 5 分钟):
- 自动检测服务状态
- 故障时自动重启
- 资源使用监控

**自动备份** (每日凌晨 3 点):
- 备份配置文件
- 保留 30 天
- 自动清理旧备份

**日志清理** (每周日凌晨 2 点):
- 清理过期日志
- 释放磁盘空间
- 保留 7 天日志

---

## 🛡️ 安全最佳实践

### 10. 安全特性

**网络安全**:
- 默认本地绑定 (127.0.0.1)
- 推荐使用 SSH 隧道或 Nginx 反向代理
- Token 认证保护

**权限隔离**:
- 专用 openclaw 用户
- 非 root 运行
- 最小权限原则

**数据保护**:
- 自动配置备份
- 重装前备份确认
- 敏感信息环境变量化

---

## 📈 性能优化

### 11. 系统优化

**内存管理**:
- 低内存自动创建 Swap
- Session 自动压缩
- 定期清理缓存

**并发控制**:
- Agent 并发限制
- 速率限制保护
- 资源使用监控

**日志管理**:
- 自动轮转
- 大小限制
- 定期清理

---

## 🔄 更新与维护

### 12. 维护功能

**更新机制**:
- `-u` 参数保留配置更新
- 自动重启服务
- 版本检查

**诊断工具**:
- `openclaw doctor` 自动诊断
- 配置验证
- 依赖检查

**监控面板**:
- 实时性能统计
- 资源使用图表
- 错误日志查看

---

## 📦 支持的环境变量

### 13. 环境变量

**网关配置**:
- `GATEWAY_BIND` - 绑定地址 (默认: 127.0.0.1)
- `GATEWAY_PORT` - 端口 (默认: 18789)

**API 密钥**:
- `OPENAI_API_KEY` - OpenAI API 密钥
- `ANTHROPIC_API_KEY` - Anthropic API 密钥
- `DEEPSEEK_API_KEY` - DeepSeek API 密钥
- `GOOGLE_API_KEY` - Google API 密钥

**频道配置**:
- `TELEGRAM_BOT_TOKEN` - Telegram Bot Token
- `DISCORD_BOT_TOKEN` - Discord Bot Token

**其他**:
- `API_BASE_URL` - API 服务商地址
- `GATEWAY_TOKEN` - Gateway 访问 Token

---

## 🎯 使用场景

### 14. 典型应用

**个人助理**:
- 任务管理和提醒
- 笔记记录和搜索
- 日程安排

**开发助手**:
- 代码搜索和分析
- GitHub 集成
- 文档查询

**内容处理**:
- 视频下载和处理
- 图像处理
- PDF 文本提取

**自动化**:
- 定时任务执行
- 数据备份
- 系统监控

---

## 📝 文件清单

### 15. 项目文件

**主脚本**:
- `install.sh` - 主安装脚本 (713 行)
- `README.md` - 项目文档 (203 行)
- `LICENSE` - MIT 许可证
- `.gitignore` - Git 忽略规则

**运维脚本** (`scripts/`):
- `manager.sh` - 管理面板 (1198 行)
- `health-monitor.sh` - 健康监控 (181 行)
- `backup.sh` - 自动备份 (61 行)
- `log-cleanup.sh` - 日志清理 (35 行)
- `restore.sh` - 恢复向导 (约 100 行)

**参考文档**:
- `openclaw配置参考.txt` - 完整配置参考 (1562 行)

---

## 🎓 技术栈

### 16. 使用的技术

**脚本语言**:
- Bash Shell (主要)
- Node.js (OpenClaw CLI)
- Python 3 (AI 工具)

**系统服务**:
- Systemd (服务管理)
- Cron (定时任务)

**包管理**:
- APT (系统包)
- NPM (Node.js 包)
- Snap (Chromium)
- Homebrew (Linuxbrew)

**工具链**:
- ripgrep, fd, bat (开发工具)
- ffmpeg, imagemagick (媒体处理)
- GitHub CLI (版本控制)

---

## 📊 统计信息

### 17. 项目规模

**代码量**:
- 主安装脚本: 713 行
- 管理面板: 1198 行
- 监控脚本: 181 行
- 总计: 约 2200+ 行 Bash 代码

**功能模块**: 17 个主要功能模块
**运维脚本**: 5 个独立脚本
**配置文件**: 5 个核心配置文件
**支持的 AI 模型**: 4+ 个提供商

---

## 🔮 未来规划

### 18. 待优化功能

**智能配置**:
- 自动检测 OpenClaw 真实配置文件
- 智能推荐配置选项
- 配置模板库

**增强监控**:
- Prometheus 指标导出
- Grafana 仪表盘
- 告警规则引擎

**多平台支持**:
- Debian/CentOS 支持
- Docker 容器化
- Kubernetes 部署

**备份增强**:
- 云存储集成
- 增量备份
- 加密备份

---

## 📞 支持与贡献

**项目地址**: https://github.com/KnowHunters/openclaw-deploy  
**问题反馈**: GitHub Issues  
**贡献指南**: 欢迎 Pull Request  
**许可证**: MIT License

---

**文档结束**
